/**
 * @file TrendSight Boutique Firestore Security Rules
 * @version 2
 *
 * @Core Philosophy:
 * This ruleset implements a hybrid security model, balancing public read access for catalog browsing with strict user-ownership and admin-controlled write access for sensitive data. User data is isolated under their respective user IDs. Administrative privileges are granted based on the existence of a document in the `/roles_admin/{userId}` collection.
 *
 * @Data Structure:
 * - `/users/{userId}`: User profile information, accessible only to the user themselves.
 * - `/clothing_items/{clothingItemId}`: Publicly readable catalog of clothing items, manageable only by admins.
 * - `/style_guides/{styleGuideId}`: Publicly readable collection of style guides, manageable only by admins.
 * - `/users/{userId}/orders/{orderId}`: Orders placed by a specific user, accessible only to the user and admins.
 * - `/users/{userId}/orders/{orderId}/order_items/{orderItemId}`: Items within a specific order, accessible only to the user who placed the order and admins.
 * - `/roles_admin/{userId}`: Collection to manage admin roles. The existence of a document indicates admin privileges.
 *
 * @Key Security Decisions:
 * - **Public Read Access**: The `clothing_items` and `style_guides` collections are publicly readable to allow for catalog browsing without authentication.
 * - **Admin-Only Writes**: Create, update, and delete operations on `clothing_items` and `style_guides` are restricted to users with admin privileges.
 * - **User-Owned Data**: User profiles and their associated orders and order items are strictly controlled, granting access only to the user themselves (and admins).
 * - **Admin Role Management**: Admin privileges are granted by the existence of a document in the `/roles_admin/{userId}` collection.
 * - **No User Listing**: Listing of all users is implicitly denied to prevent information disclosure.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isAdmin() {
      return request.auth != null && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description: Protects user profiles. Only the user with the matching userId can read/write their profile.
     * @path: /users/{userId}
     * @allow: User (create) can create their own profile if the userId matches their auth.uid.
     * @allow: User (get, update, delete) can access their profile if the userId matches their auth.uid.
     * @deny: User cannot access another user's profile.
     * @principle: Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description: Controls access to clothing items. Admins can create, update, and delete items. Public read access for catalog browsing.
     * @path: /clothing_items/{clothingItemId}
     * @allow: Any user (read) can read clothing items.
     * @allow: Admin (write) can manage clothing items.
     * @deny: Non-admin users cannot create, update, or delete clothing items.
     * @principle: Provides public read access while restricting write access to authorized administrators.
     */
    match /clothing_items/{clothingItemId} {
        allow read: if true;
        allow write: if isAdmin();
    }

    /**
     * @description: Controls access to style guides. Admins can create, update, and delete style guides. Public read access.
     * @path: /style_guides/{styleGuideId}
     * @allow: Any user (get, list) can read style guides.
     * @allow: Admin (create, update, delete) can manage style guides.
     * @deny: Non-admin users cannot create, update, or delete style guides.
     * @principle: Provides public read access while restricting write access to authorized administrators.
     */
    match /style_guides/{styleGuideId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description: Protects orders. Only the user with the matching userId can read/write their orders. Admins can also access all orders.
     * @path: /users/{userId}/orders/{orderId}
     * @allow: User (get, list, create, update, delete) can manage their own orders if the userId matches their auth.uid.
     * @allow: Admin (get, list, create, update, delete) can manage all orders.
     * @deny: User cannot access another user's orders.
     * @principle: Enforces document ownership and allows admin override for managing orders.
     */
    match /users/{userId}/orders/{orderId} {
      allow get, list: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update, delete: if (isOwner(userId) && resource != null) || isAdmin();

       /**
       * @description: Allows admins to list all orders across all users.
       * @path: /orders/{orderId} (collection group)
       * @allow: Admin (list) can list all orders.
       * @deny: Non-admin users cannot list all orders.
       * @principle: Enables admin-level order management.
       */
      match /order_items/{orderItemId} {
        allow get, list: if isOwner(userId) || isAdmin();
        allow create: if isOwner(userId);
        allow update, delete: if (isOwner(userId) && resource != null) || isAdmin();
      }
    }
    
    match /{path=**}/orders/{orderId} {
        allow list: if isAdmin();
    }


    /**
     * @description: Grants admin privileges. The first user can self-assign the admin role. Subsequent admin roles can only be created by existing admins.
     * @path: /roles_admin/{userId}
     * @allow: A user can create their own admin role document if no other admins exist.
     * @allow: An existing admin can create or delete other admin roles.
     * @principle: Bootstraps the first admin and secures role management thereafter.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if (request.auth.uid == userId && !exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid)) && get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)) == null) || isAdmin();
      allow update: if false;
      allow delete: if isAdmin();
    }
  }
}
